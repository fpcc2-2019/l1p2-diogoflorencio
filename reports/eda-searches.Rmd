---
title: "EDA buscas"
output: 
  html_notebook:
    theme: lumen
    fig_width: 7
    toc: true
    toc_float: true
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

O objeto principal da análise são as buscas e a navegação depois da busca. Criamos esses dados a partir dos dados originais da wikimedia em `/data/search_data.csv`. 

Aqui, exploramos esses dados. 

```{r setup}
library(tidyverse)
library(here)
library(lubridate)
theme_set(theme_bw())
options(warn=-1) # ignore warns
```

```{r ETL}
buscas = read_csv(here::here("data/search_data.csv"))
```

# Explorando os dados

```{r}
buscas %>% 
    ggplot(aes(x = num_clicks)) + 
    geom_histogram(binwidth = 1) 
```

```{r}
buscas %>% ggplot(aes(x= session_start_date)) +
    geom_histogram() + 
    coord_flip()

buscas %>% 
  ggplot(aes(x=session_start_timestamp)) +
  geom_density(alpha = .4, fill='purple') +
  labs(title = "density session_start_timestamp")

```

```{r}
buscas %>%  ggplot(aes(x=session_length, y=num_clicks))+
    geom_point()+
    labs(title = "session_length x num_clicks")

buscas %>% 
  ggplot(aes(x=session_length)) +
  geom_density(alpha = .4, fill='red') +
  labs(title = "density session_length")

buscas %>% 
  ggplot(aes(x=num_clicks)) +
  geom_density(alpha = .4, fill='blue') +
  labs(title = "density num_clicks")

```

```{r}
buscas %>% 
  filter(session_length <= 100000) %>%
  filter(num_clicks <= 25) %>%
  ggplot(aes(x=session_length, y=num_clicks)) +
  geom_point() +
  labs(title = "session_length x num_clicks without outliers")
```


```{r}
buscas %>% 
  ggplot(aes(x=results, y=search_index)) +
    geom_point() +
    labs(title = "results x search_index")

buscas %>% 
  ggplot(aes(x=results)) +
  geom_density(alpha = .4, fill='red') +
  labs(title = "density results")

buscas %>% 
  ggplot(aes(x=search_index)) +
  geom_density(alpha = .4, fill='red') +
  labs(title = "density search_index")

```

```{r}
buscas %>% 
  filter(results <= 25) %>%
  ggplot(aes(x=results)) +
  geom_density(alpha = .4, fill='orange') +
  labs(title = "dist results")

buscas %>% 
  filter(session_length <= 100000) %>%
  ggplot(aes(x=session_length, y=results)) +
    geom_point() +
    labs(title = "session_length x results")
```

# 1. What is our daily overall clickthrough rate? How does it vary between the groups?

```{r}
buscas$session_start_date <- buscas$session_start_date %>% as.Date("%d/%m/%Y")

buscas %>%
  group_by(session_start_date) %>%
  mutate(clicks_per_day = sum(num_clicks)) %>%
  ggplot(aes(x=session_start_date, y=clicks_per_day)) +
  geom_point() +
  geom_line() +
  labs(title = "clicks_per_day")

buscas %>%
  group_by(group, session_start_date) %>%
  mutate(clicks_per_day = sum(num_clicks)) %>%
  ggplot(mapping = aes(x=session_start_date, y=clicks_per_day, color = group)) +
  geom_point() +
  geom_line() +
  facet_grid(group ~ .) +
  labs(title = "clicks_per_day")
```

# 2. Which results do people tend to try first? How does it change day-to-day?

```{r}
buscas %>% 
  filter(!is.na(first_click)) %>% 
  group_by(first_click) %>% 
  filter(n() >= 20) %>%
  ggplot(aes(x=first_click)) +
  geom_density(fill = "green", color= "red", alpha = .4)

buscas %>% 
  filter(!is.na(first_click)) %>% 
  group_by(first_click, session_start_date) %>% 
  summarise(num_clicks = n()) %>%
  filter(num_clicks >= 20) %>%
  ggplot(aes(x=first_click, y = num_clicks)) +
  facet_wrap(~session_start_date) +
  geom_area(fill = "green", color = "red")

```

# 3. What is our daily overall zero results rate? How does it vary between the groups?

```{r}
buscas %>% 
    filter(results == 0) %>% 
    group_by(session_start_date) %>% 
    mutate(num_results_0 = n()) %>% 
    ggplot(aes(x = session_start_date, y = num_results_0)) +
    geom_line() +
    labs(
      title = "Distribution of results 0",
      x = "Date",
      y = "Number of results 0"
    )

buscas %>% 
    filter(results == 0) %>% 
    group_by(group, session_start_date) %>% 
    mutate(num_results_0 = n()) %>% 
    ggplot(aes(x = session_start_date, y = num_results_0, color = group)) +
    geom_line() +
    facet_grid(group ~ .) +
    labs(
      title = "Distribution of results 0",
      x = "Date",
      y = "Number of results 0"
    )

```

# 4. Let session length be approximately the time between the first event and the last event in a session. Choose a variable from the dataset and describe its relationship to session length. Visualize the relationship.

```{r}
buscas %>%
    filter(session_length <= 100000) %>%
    ggplot(aes(x = session_length, y = results)) +
    geom_point()

buscas %>% 
    filter(session_length <= 100000) %>%
    summarise(pearson = cor(session_length, results, method = "pearson"), 
        spearman = cor(session_length, results, method = "spearman"), 
        kendall = cor(session_length, results, method = "kendall"))

```
